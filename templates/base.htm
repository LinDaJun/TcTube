<!DOCTYPE html>
<html>
    <head>
        {% block head %}
        {% block meta %}
        <meta charset="UTF-8">
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta http-equiv="content-language" content="zh-tw">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
        <meta name="author" content="Tcc">
        {% endblock %}

        {% block icon %}
        <link rel="icon" href="/file/favicon.png">
        {% endblock %}

        {% block title %}
        <title>{{ title }} - TcTube</title>
        {% endblock %}

        {% block css %}
        <link rel="stylesheet" href="/file/css/reset.css">
        <link rel="stylesheet" href="/file/css/main.css">
        {% endblock %}
        {% endblock %}
    </head>
    <body>
    {% block body %}
        {% block header %}
        <header id="header" class="">
            <a href="/"><img src="/file/Favicon.png" alt=""><h1>TcTube</h1></a>
        </header>
        {% endblock %}
        {% block marquee %}
        <ul id="marquee" class="marquee">
        {% for announcement in announcements %}
            <li><h3>{{announcement.message}}</h3></li>
        {% endfor %}
        </ul>
        {% endblock %}
        {% block menu %}
        <nav id="menu" type="context toolbar"></nav>
        {% endblock %}
        <main>
        {% block main %}
        {% endblock %}
        </main>
        {% block javascript %}
        <script src="/file/js/login.js"></script>
        <script src="/file/js/dtree.js"></script>
        <script src="/file/js/jquery-1.12.4.min.js"></script>
        <script src="/file/js/jquery.marquee.min.js"></script>
        <script>
            document.addEventListener("readystatechange", function init(event) {
                if (document.readyState === "complete") {
                    console.log("complete");
                    if (typeof menu !== "undefined") {
                        dtree = new dTree('dtree');
                        dtree.add(0, -1, '{{current_user.name}}<br>{{current_user.login_ip}}<br>{{current_user.login_time}}');
                        {% for item in menu %}
                        dtree.add({{item.id}}, {{item.parent_id}}, "{{item.name}}", "{{item.url}}", "{{item.title}}", "{{item.target}}", "{{item.icon}}", "{{item.icon_open}}", {% if item.open == 1 %}true{% else %}false{% endif %}, "{{item.onclick}}");{% endfor %}
                        menu.innerHTML  = dtree;
                    }
                    jQuery("#marquee").marquee({
                        speed: 10
                    //     gap: 50,
                    //     delayBeforeStart: 0,
                    //     direction: 'left',
                    //     duplicated: true,
                    //     pauseOnHover: true
                    }); // 執行跑馬燈
                }
            }, false);
        </script>
        <script src="/file/js/socket.io-1.4.8.min.js"></script>
        <script>
            var socket = io.connect('http://' + document.domain + ':' + location.port + "/test");

            socket.on('connect', function() {
                console.log('connect');
            });
            socket.on('disconnect',  function() {
                console.log('close');
            });
            socket.on('bye', function(data) {
                console.log('bye');
                socket.close();
            });
            socket.on('hello', function(data) {
                console.log('Hello ' + data["name"] + "(" + data["ip"] + ")!!");
            });
            socket.on('redirect', function(data) {
                console.log('redirect');
                setTimeout(function() {
                    socket.emit("bye", {});
                    window.location = data['url'];
                }, data['time'] - new Date().getTime() - new Date().getTimezoneOffset() * 60000);
            });
            socket.on('pause', function(data) {
                console.log('pause');
                setTimeout(function() {
                    if (typeof video !== "undefined") {
                        video.pause();
                        video.currentTime = 0;
                        video.play();
                    }
                }, data['time'] - new Date().getTime() - new Date().getTimezoneOffset() * 60000)
            });
            socket.on('hideAnnouncements', function(data) {
                console.log('hideAnnouncements');
                document.body.className = "nomessage";
            });
            function PushVideo() {
                socket.emit('PushVideo', {
                    id: parseInt(prompt("請輸入推播影片編號:", 0)),
                    delay: 5000
                });
            }
        </script>
        {% endblock %}
    {% endblock %}
    </body>
</html>